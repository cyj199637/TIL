# [02강] 컨텍스트 스위칭 의미와 종류
(강의 자료 링크: https://www.youtube.com/watch?v=Xh9Nt7y07FE)

## 컨텍스트 스위칭은 무엇인가?

### 컨텍스트 스위칭

CPU/코어에서 실행 중이던 프로세스/스레드가 다른 프로세스/스레드로 교체되는 것

<br/>

cf) 프로그램, 프로세스, 스레드
* 프로세스는 실행 중인 프로그램을 의미한다.
* 하나의 프로세스는 최소 하나 이상의 스레드를 가진다.
* 스레드는 CPU 코어에서 실행 혹은 스케줄링되는 기본 단위다.

<br/>

* 프로그램이 메모리에 올라가서 실행 중인 상태가 된 것을 프로세스라 부르고
* 한 프로세스는 최소 하나 이상의 스레드들로 동작하게 되며,
* 이때 이 스레드들 각각이 CPU 코어에서 실행된다고 볼 수 있다.


그래서 프로세스에서 프로세스로 교체된다는 말은 사실 어떤 프로세스 안에 실행되는 스레드가 다른 프로세스 안에 실행되는 스레드로 바뀐다는 말이다.

<br/>

### 컨텍스트

프로세스/스레드의 상태

- 여기서 상태는 CPU나 메모리에서의 상태를 의미한다.

<br/>

cf) CPU 레지스터
* CPU 내부의 작은 임시 저장장치
* 프로그램 속 명령어와 데이터는 실행 전후로 레지스터에 저장
* CPU마다 레지스터 종류 및 개수 등이 다 다르다.
  

<br/><br/>

## 컨텍스트 스위칭은 왜 필요한가?

→ 여러 프로세스/스레드를 동시에 실행시키기 위해서

<br/><br/>

## 컨텍스트 스위칭은 언제 발생하는가?

- 주어진 타임 슬라이스를 다 사용했거나
- IO 작업을 해야하거나
- 다른 프로세스나 스레드에서 사용하고 있는 리소스를 기다려야 하거나
- 인터럽트가 걸렸거나
- …

<br/><br/>

## 컨텍스트 스위칭은 누구에 의해 실행되는가?

→ OS 커널

- 각종 리소스를 관리/감독하는 역할
- 컨텍스트 스위칭을 총괄해서 통제권을 가지고 집행/수행하는 존재

  (컨텍스트 스위칭의 발생 트리거가 아님)


- 커널
    - CPU, 메모리 등 컴퓨터에 존재하는 다양한 리소스들을 관리/감독

<br/><br/>

## 컨텍스트 스위칭은 구체적으로 어떤 과정으로 일어나는가?

다른 프로세스끼리 스위칭(프로세스 컨텍스트 스위칭)인지 같은 프로세스의 스레드들끼리 스위칭(스레드 컨텍스트 스위칭)인지에 따라 다르다.

CPU 코어에서 실행되는 단위가 스레드이기 때문에 프로세스 컨텍스트 스위칭도 당연히 스레드 간의 컨텍스트 스위칭으로 동작한다.

그러나 프로세스 컨텍스트 스위칭은 서로 다른 프로세스에 속한 스레드 간의 컨텍스트 스위칭이 발생하는 것이다.

<br/>

### 공통점

1. 커널 모드에서 실행

   → 현재 실행되고 있는 프로세스/스레드의 CPU 상태를 저장하고, 다음 프로세스/스레드의 CPU 상태를 로딩하기 위해

    - 커널 모드
        - OS 커널로 통제권이 넘어가서 커널에 실행되는 상황
        - ex) 프로세스가 하드웨어 등의 컴퓨터의 리소스를 다뤄야 할 때 리소스에 직접 접근하지 않고 OS 커널을 통해 접근을 하게 됨
2. CPU의 레지스터 상태를 교체

   → 현재 실행되고 있는 프로세스/스레드도 다음 자기 차례가 왔을 때 현재 작업을 이어서 해야 되기 때문에 컨텍스트 스위칭 직전에 실행되고 있던 프로세스/스레드의 레지스터 상태 정보를 저장해야 함

    - 레지스터
        - 각종 명령어를 수행하기 위한 필요한 데이터를 저장하는 역할

<br/>

### 차이점
컨텍스트 스위칭은 아래 작업들을 수행한다.
- 현재 실행 중인 프로세스/스레드의 컨텍스트 백업
  - ex) CPU 레지스터 값들, 어디까지 실행됐는지 등
- CPU 캐시를 비움(flush)
  - CPU 마다 동작 방식이 다름. 비우지 않는 경우도 있음 
- TLB를 비움
  - TLB(table lookaside buffer)
    - 가상 메모리 주소와 실제 물리 메모리 주소의 매핑 정보를 저장
- MMU 설정 변경
  - MMU(memory management unit)
    - CPU가 메모리에 접근하는 것을 관리
    - 가상 메모리와 실제 물리 메모리 사이에서 주소 변환

<br/>

스레드 컨텍스트 스위칭은 1번만 수행한다.

그러나 프로세스 컨텍스트 스위칭은 가상 메모리 주소 관련 처리(2, 3, 4번)를 추가로 수행한다.

(만약 수행하지 않으면 컨텍스트 스위칭 이전의 프로세스의 메모리 영역으로 잘못 접근하게 될 수도 있음)

<br/><br/>

## 스레드 컨텍스트 스위칭이 더 빠른 이유

서로 다른 프로세스는 서로 다른 메모리 주소 공간을 가진다.

따라서 프로세스 컨텍스트 스위칭을 할 때 새로 실행되는 프로세스가 기존에 실행되던 프로세스의 메모리 주소 공간에 침범하면 안 되기 때문에 위의 모든 컨텍스트 스위칭 작업을 수행하는 것이다.

특히 CPU 캐시와 TLB를 비워주는 작업이 시간을 꽤 잡아먹기 때문에 프로세스 컨텍스트 스위칭은 스레드 컨텍스트 스위칭에 비해서 오래 걸린다.

<br/>

반면 스레드 컨텍스트 스위칭의 경우에는 같은 메모리 공간을 공유하기 때문에 더 빨리 끝난다.

-> 메모리 주소 관련 처리는 필요없이 CPU 상태 정보만 교체하면 됨


<br/><br/>

## 컨텍스트 스위칭이 미치는 영향

### 캐시 오염

- 컨텍스트 스위칭 직후에 실행되는 프로세스/스레드의 경우에는 필요한 데이터가 캐시에 없음

  → 필요한 데이터를 얻기 위해 메모리까지 가게 되면서 처리 성능 및 속도가 떨어지게 됨

    - 캐시에는 컨텍스트 스위칭 이전에 실행된 프로세스/스레드에서 사용했던 데이터들이 있음
- 프로세스 컨텍스트 스위칭에서 더 자주 발생
    - 같은 프로세스 내 스레드들끼리는 같은 메모리 영역을 공유하기 때문에 덜 영향을 받음

<br/><br/>

## 유저 관점에서 컨텍스트 스위칭이란?

→ 컨텍스트 스위칭은 순수한 오버헤드다

따라서, 컨텍스트 스위칭이 많이 발생할수록 유저가 실행한 프로그램의 동작과 전혀 관계 없는 간접 비용만 증가하게 된다.